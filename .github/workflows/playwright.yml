name: API and UI tests
on: 
  push:
    branches: [ main, master]
  pull_request:
    branches: [ main, master]
  workflow_dispatch:

jobs:
  e2e:
    timeout-minutes: 30
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: lts/*
      
      - name: Install dependencies
        run: npm ci

      - name: Install Playwright & Allure
        run: npx playwright install --with-deps

      - name: Run tests
        run: npm run test

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results
          path: |
            test-results
            allure-results
          retention-days: 30
      
      - name: Upload test results from last run to Github
        uses: actions/checkout@v4
        if: always()
        continue-on-error: true
        with:
          ref: gh-pages
          path: gh-pages
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Generate Allure report
        uses: simple-elf/allure-report-action@master
        if: always()
        with:
          allure_results: allure-results
          gh_pages: gh-pages
          allure_report: allure-report
          allure_history: allure-history
          keep_reports: 20

      - name: Deploy Allure report
        uses: peaceiris/actions-gh-pages@v4
        if: always()
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_branch: gh-pages
          publish_dir: allure-history

      - name: Install allurectl
        run: |
         if [ ! -f "/usr/local/bin/allurectl" ]; then
          echo "Installing allurectl..."
          curl -o allurectl -L "https://github.com/allure-framework/allurectl/releases/latest/download/allurectl_linux_amd64"
          chmod +x allurectl
          sudo mv allurectl /usr/local/bin/
         fi

      - name: Upload results to Allure TestOps
        if: always()
        run: |
          allurectl upload allure-results \
            --endpoint https://allure.autotests.cloud \
            --project-id 4988 \
            --token ${{ secrets.ALLURE_TOKEN }} \
            --launch-name "GitHub Run #${{ github.run_number }}"

      - name: Parse Allure summary
        id: parse_summary
        if: always()
        run: |
          SUMMARY_FILE="allure-report/widgets/summary.json"
          if [ -f "$SUMMARY_FILE" ]; then
            PASSED=$(jq '.statistic.passed' $SUMMARY_FILE)
            FAILED=$(jq '.statistic.failed' $SUMMARY_FILE)
            SKIPPED=$(jq '.statistic.skipped' $SUMMARY_FILE)
            TOTAL=$(jq '.statistic.total' $SUMMARY_FILE)
            echo "PASSED=$PASSED" >> $GITHUB_ENV
            echo "FAILED=$FAILED" >> $GITHUB_ENV
            echo "SKIPPED=$SKIPPED" >> $GITHUB_ENV
            echo "TOTAL=$TOTAL" >> $GITHUB_ENV
          fi

      - name: Notify Telegram
        if: always()
        run: |
          STATUS=${{ job.status }}
          if [ "$STATUS" = "success" ]; then
            EMOJI="ğŸ¾"
            STATUS_TEXT="BRAVO!"
          else
            EMOJI="ğŸ’€"
            STATUS_TEXT="FATALITY"
          fi

          MESSAGE="$EMOJI *$STATUS_TEXT* $EMOJI%0A\
          â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”%0A\
          ğŸ“Š *Ğ¡Ñ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞ° Ñ‚ĞµÑÑ‚Ğ¾Ğ²:*%0A\
          â–«ï¸ Ğ’ÑĞµĞ³Ğ¾ Ğ¿Ñ€Ğ¾Ğ¹Ğ´ĞµĞ½Ğ¾: *$TOTAL*%0A\
          âœ… Ğ£ÑĞ¿ĞµÑˆĞ½Ñ‹Ğµ: *$PASSED*%0A\
          âŒ ĞŸÑ€Ğ¾Ğ²Ğ°Ğ»ĞµĞ½Ğ¾: *$FAILED*%0A\
          â­ï¸ ĞŸÑ€Ğ¾Ğ¿ÑƒÑ‰ĞµĞ½Ğ¾: *$SKIPPED*%0A\
          â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”%0A\
          ğŸ”— [Allure Ğ¾Ñ‚Ñ‡ĞµÑ‚](https://Honeylol73.github.io/Diploma_project/)%0A\
          ğŸ§ª [Allure TestOps](https://allure.autotests.cloud/project/4988)%0A\
          ğŸ“¦ [ĞÑ€Ñ‚ĞµÑ„Ğ°ĞºÑ‚Ñ‹](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})%0A\
          â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”%0A\
          ğŸ·ï¸ *Run #${{ github.run_number }}*"

          curl -s -X POST https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage \
          -d chat_id=${{ secrets.TELEGRAM_CHAT_ID }} \
          -d parse_mode=Markdown \
          -d text="$MESSAGE"